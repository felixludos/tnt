<!DOCTYPE html>
<html>
  <head>
    <title>a94</title>
    <link rel="shortcut icon" href="" />
    <!-- <link rel="shortcut icon" href="/a/assets/palmtree.ico"> -->
    <!-- <link rel="shortcut icon" href="#" /> -->
    <link rel="stylesheet" type="text/css" href="/a/css/selectStyle.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/autocomp.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/main.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/layout.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/msStyles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.2/js-yaml.js"></script>

    <script src="/a/js/ASender.js"></script>
    <script src="/a/js/NAssets.js"></script>
    <script src="/a/js/unitTestIOHelpers.js"></script>
    <script src="/a/js/helpers.js"></script>
    <script src="/a/js/helpersTnt.js"></script>
    <script src="/a/js/panzoom.js"></script>
    <script src="/a/js/MS.js"></script>
    <script src="/a/js/NPage.js"></script>
    <script src="/a/js/AMap.js"></script>
    <script src="/a/js/AHand.js"></script>
    <script src="/a/js/ACards.js"></script>
    <script src="/a/js/AUnits.js"></script>
    <script src="/a/js/AStrategy.js"></script>
    <script src="/a/js/ADecisiongen.js"></script>
    <script src="/a/js/unitTests.js"></script>
  </head>
  <body>
    <!-- #region HTML -->
    <div id="mainDiv" class="grid_game">
      <div id="status_area" class="grid_div">
        <div id="status_info" style="float:right;margin-right:10px;"></div>
        <div id="ui_control" style="float:left;text-align:left;margin-left:10px;">
          <div id="dFrozen" style="color:darkviolet;">wait...</div>
          <div id="dAutoplay" class="hidden" style="color:red;">
            autoplay...
            <button id="bStop" style="color:white;background-color:red" onclick="onClickStop()">STOP</button>
          </div>
          <div id="dActive" class="hidden" style="color:rgb(0, 104, 0);">Select Action:</div>
          <button id="bNextPlayer" class="hidden" style="color:green;" onclick="onClickNextPlayer()">Next Player</button>
        </div>
        <div id="status_message"></div>
      </div>
      <div id="map_area" class="grid_div" style="background-color:rgba(86, 182, 222);">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="mapG" viewBox="0 0 3400 2200">
            <image id="imgMap" width="3400" height="2200" href="/a/assets/TTmap.jpg" />
          </g>
        </svg>
      </div>
      <div id="edit_area" class="grid_div">
        <div id="uiEditButtons">
          <button id="bSpringStart" onclick="onClickScenario(this,'string_start')">
            spring start
          </button>
          <button id="bMovement" onclick="onClickScenario(this,'test_movement')">
            movement
          </button>
          <button id="bMovement2" onclick="onClickScenario(this,'move2')">
            move 2
          </button>
          <!-- <p style="margin-bottom:0px;font-size:14pt;">front ONLY:</p>
          <button id="bAddInfluence" onclick="onClickAddInfluence(this)">
            add influence
          </button>
          <button id="bRemoveInfluence" onclick="onClickRemoveInfluence(this)">
            remove influence
          </button>
          <p style="margin-bottom:0px;font-size:14pt;">front+back:</p>
          <button id="bEditTest" class="hidden" style="margin-top:24px;" onclick="onClickEditTest(this)">
            edit test
          </button>
          <button id="bAddUnit" class="hidden" onclick="onClickAddUnit(this)">add unit</button> -->
        </div>
      </div>
      <div id="select_area" class="grid_div">
        <div id="divSelect" class="sidenav"></div>
      </div>
      <div id="command_area" class="grid_div">
        <div id="uiActiveButtons" class="hidden">
          <button id="bStep" onclick="decider.onClickStep()">step</button>
          <button id="bRunToEnd" onclick="onClickRunToEnd()">run to end</button>
          <button id="bRunToSpring" onclick="onClickRunToSpring()">run to spring</button>
          <!-- <button id="bPlayWest" onclick="onClickPlay(this)">play West</button>
          <button id="bPlayUSSR" onclick="onClickPlay(this)">play USSR</button>
          <button id="bPlayAxis" onclick="onClickPlay(this)">play Axis</button> -->
          <button id="bRestart" style="margin-top:24px;background-color:orangered;" onclick="onClickRestart(this)">restart</button>
          <button id="bRestartParams" style="background-color:orangered;" onclick="onClickRestartParams(this)">
            restart params
          </button>
        </div>
      </div>
      <div id="log_area" class="grid_div" style="max-height:760px;overflow-y:scroll"></div>
      <div id="command2_area" class="grid_div">
        <div id="ui2Buttons">
          <button id="bSave" onclick="onClickSave()">save</button>
          <button id="bLoad" onclick="onClickLoad()">load</button>

          <button id="bSave" onclick="onClickSaveAs()">save as</button>
          <button id="bLoad" onclick="onClickLoadAs()">load as</button>
        </div>
      </div>
      <div id="hand_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="handG_Axis" style="visibility:hidden"><text x="10" y="25" fill="grey">Axis</text></g>
          <g id="handG_USSR" style="visibility:hidden"><text x="10" y="25" fill="red">USSR</text></g>
          <g id="handG_West" style="visibility:hidden"><text x="10" y="25" fill="blue">West</text></g>
        </svg>
      </div>
      <div id="cards2_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="openCardG"><text x="10" y="25" fill="grey">open</text></g>
          <g id="actionDeckG"><text x="10" y="25" fill="grey">action</text></g>
        </svg>
      </div>
      <div id="cards3_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="discardedG"><text x="10" y="25" fill="grey">discarded</text></g>
          <g id="investmentDeckG"><text x="10" y="25" fill="grey">investment</text></g>
        </svg>
      </div>
    </div>
    <!-- #endregion HTML -->

    <!-- #region UI / handlers -->
    <script>
      function activateWaitingForServer() {
        show(document.getElementById("dFrozen"));
        hide(document.getElementById("dAutoplay"));
        hide(document.getElementById("dActive"));
        hide(document.getElementById("uiActiveButtons"));
        hide(document.getElementById("uiEditButtons"));
        hide(document.getElementById("bNextPlayer"));
      }
      function activateNextPlayerButton() {
        hide(document.getElementById("dFrozen"));
        hide(document.getElementById("dAutoplay"));
        hide(document.getElementById("dActive"));
        hide(document.getElementById("uiActiveButtons"));
        hide(document.getElementById("uiEditButtons"));
        show(document.getElementById("bNextPlayer"));
      }
      function activateUserSelection() {
        hide(document.getElementById("dFrozen"));
        hide(document.getElementById("dAutoplay"));
        show(document.getElementById("dActive"));
        show(document.getElementById("uiActiveButtons"));
        show(document.getElementById("uiEditButtons"));
        hide(document.getElementById("bNextPlayer"));
      }
      function activateAutoplay() {
        hide(document.getElementById("dFrozen"));
        show(document.getElementById("dAutoplay"));
        hide(document.getElementById("dActive"));
        hide(document.getElementById("uiActiveButtons"));
        hide(document.getElementById("uiEditButtons"));
        hide(document.getElementById("bNextPlayer"));
      }
      function callNextAction() {
        if (nextAction) {
          activateWaitingForServer();
          nextAction();
        } else {
          error("NO NEXT ACTION!!!!!!!");
        }
      }
      function freezeUI() {
        decider.clear();
        activateWaitingForServer();
      }
      function unfreezeUI() {
        //decider.clear();
        activateUserSelection();
      }
      function printActions(data) {
        if ("actions" in data) {
          console.log(data.actions);
          // if ('set' in data.actions){
          //   console.log(data.actions.set.toString());
          // }else{
          //   console.log(data.created.toString());
          // }
        } else {
          console.log("... no actions ...");
        }
      }
      function printCreatedUnits(data) {
        console.log("...created:");
        if ("created" in data) {
          for (const id in data.created) {
            let o = data.created[id];
            if (o.obj_type != "unit") continue;
            console.log(id, o.nationality, o.tile, o.type);
          }
        }
      }
      function onClickScenario(btn, filename) {
        freezeUI();
        restart("West", filename);
        // switch (btn.id) {
        //   case "bSpringStart":
        //     restart("West", "spring_start");
        //     break;
        //   case "bMovement":
        //     restart("West", "test_movement");
        //     break;
        //   // case bProduction: restart('West','spring_start',seed); break;
        //   // case bSpringStart: restart('West','spring_start',seed); break;
        //   // case bSpringStart: restart('West','spring_start',seed); break;
        //   default:
        // 		let pl = chooseRandom(assets.factionNames);
        // 		let seed = randomNumber();
        //     console.log("restarting with", pl, assets.factionNames.toString());
        //     restart(pl, filename, seed);
        // }
      }
      function onClickAddUnit() {
        freezeUI();
        let dOrig = serverData;
        console.log(dOrig);
        let tuple = randomUnitTuple();
        sendEditAction(player, tuple, dEdit => {
          console.log("back from edit", dEdit);
          if ("created" in dEdit) {
            dOrig = extend(true, dOrig, dEdit);
            console.log("nach extend und edit", dOrig);
            printCreatedUnits(dOrig);
            printActions(dOrig);
          }
          gameloop(dOrig);
        });
      }
      function onClickAddInfluence() {
        testAddInfluence(map, gameObjects);
      }
      function onClickRemoveInfluence() {
        testRemoveInfluence(map, gameObjects);
      }
      function onClickEditTest() {
        //enter edit mode
        // in edit mode, all units are visible
        if (execOptions.mode != "edit") {
          execOptions.mode = "edit";
        }
        //decider.cancel();
        testEdit(serverData);
        //sender.send('edit/'+player+'/USSR+Moscow+Infantry',dEdit=>{
        //  let newUnit = Object.values(dEdit.created)[0];
        //  let newId = Object.keys(dEdit.created)[0];
        //  dInit.created[newId]=newUnit;
        //  gameloop(dInit);
        //});
        //restart with random player, do NOT change role!
        //let pl = chooseRandom(assets.factionNames);
        //console.log("restarting with", pl, assets.factionNames.toString());
        //restart(pl);
      }
      function onClickNextPlayer() {
        callNextAction();
      }
      function onClickPlay(b) {
        // do not restart, just change role: execOptions.skipCond
        //b.classList.add('selected')
        //was ich will wenn einer auch playWest clicked:
        //toggle

        let pl = stringAfter(b.id, "Play");
        //toggle this player
        console.log("before toggle", execOptions.manualPlay.toString());
        console.log(execOptions.skipCond);
        if (execOptions.manualPlay.includes(pl)) {
          console.log("player", pl, "is in manualPlay!");
          removeInPlace(execOptions.manualPlay, pl);
          console.log(execOptions.manualPlay);
          b.classList.remove("toggleSelected");
        } else {
          console.log("player", pl, "is NOT in manualPlay!");
          execOptions.manualPlay.push(pl);
          b.classList.add("toggleSelected");
        }
        console.log("after toggle", execOptions.manualPlay.toString());
        console.log(execOptions.skipCond, player);
        STOP = false;
        decider.onClickStep();
      }
      function onClickRestart() {
        //restart with random player, do NOT change role!
        let pl = chooseRandom(assets.factionNames);
        console.log("restarting with", pl, assets.factionNames.toString());
        restart(pl);
      }
      function onClickRestartParams() {
        params = prompt("enter player [seed]:");
        let pl = capitalize(stringBefore(params, " "));
        let seed = firstNumber(params);
        if (seed < 0) seed = randomNumber();
        console.log("restarting with player", pl, "and seed", seed);
        restart(pl, "", seed);
      }
      function onClickRunToEnd() {
        STOP = false;
        execOptions.manualPlay = []; //skipCond = () => true;
        decider.onClickStep();
      }
      function onClickRunToSpring() {
        STOP = false;
        execOptions.skipCond = () => phase != "Spring";
        decider.onClickStep();
      }
      function onClickLoad() {
        freezeUI();
        restart(player, "test1");
      }
      function onClickSave() {
        freezeUI();
        let dOrig = serverData;
        sender.send("savetest1", d => {
          sender.send("status/" + player, d1 => {
            unfreezeUI();
            gameloop(dOrig);
          });
        });
      }
      function onClickLoadAs() {
        fname = prompt("filename no ext.:");
        freezeUI();
        restart("West", fname);
      }
      function onClickSaveAs() {
        fname = prompt("filename no ext.:");
        freezeUI();
        let dOrig = serverData;
        sender.send("mysave/" + fname, d => {
          sender.send("status/" + player, d1 => {
            unfreezeUI();
            gameloop(dOrig);
          });
        });
      }
      function onClickStop() {
        unitTestControl("*** onClickStop!!! ***");
        STOP = true;
      }
      function statusMessage(msg = "") {
        let s = "Phase:" + phase + ", Year:" + year + ", Player:" + player;
        document.getElementById("status_info").innerHTML = s;
        if (!empty(msg)) document.getElementById("status_message").innerHTML = msg;
      }
    </script>
    <!-- #endregion handlers -->

    <!-- #region control flow -->
    <script>
      function gameloop(data) {
        //update
        serverData = data;

        // STOP = unitTestRemovedCheck(data);

        unitTestControl("*** gameloop: updating ***", data);
        testOutput({0: ["gameloop:", data]});

        updateStepPlayerPhaseYear(data);
        updateLog(data);
        mergeCreatedAndUpdated(data);
        cards.update(player, data, gameObjects);
        map.update(data, gameObjects);
        units.update(data, gameObjects, player);

        //next action
        tuples = getTuples(data);

        make_G();

        //player change if no actions OR decide next action
        if (empty(tuples)) {
          let waitingSet = getSet(data, "waiting_for");
          if (empty(waitingSet)) {
            unitTestControl("*** gameloop: sending empty action ***");
            sendEmptyAction(player, gameloop);
          } else {
            unitTestControl("*** gameloop: setting nextAction to sendChangeToPlayer ***");
            nextAction = () => sendChangeToPlayer(waitingSet[0], gameloop);

            //player change manual or automatic:
            if (execOptions.playerChange == "auto") callNextAction();
            else show(bNextPlayer);
          }
        } else {
          //actions: decider generates a move:
          let autoplay = execOptions.skipCond() && !STOP;
          if (autoplay) activateAutoplay();
          else {
            execOptions.skipCond = defaultSkipCond;
            activateUserSelection();
          }
          unitTestControl("*** gameloop: calling decider.genMove ***");
          unitTestControl("autoplay:", autoplay, "player", player);
          decider.genMove(G, t => sendAction(player, t, gameloop), autoplay);
        }
        window.scrollTo(0, 0);
      }
      function make_G() {
        G.player = player;
        G.phase = phase;
        G.year = year;
        G.tuples = tuples;
        G.objects = gameObjects;
        G.serverData = serverData;
      }
      function restart(pl, filename = "", seed = 5) {
        player = pl;
        year = 1935;
        phase = "Setup";
        gameObjects = {};
        nextAction = null;
        moveCounter = 0;
        STOP = false;
        sender = new ASender(execOptions);

        page.clearAllObjects();
        map = new AMap(assets);
        cards = new ACards(assets);
        units = new AUnits(assets);
        decider = new ADecisiongen(assets);
        if (empty(filename)) sendInit(player, gameloop, seed);
        else sendLoading(filename, player, gameloop);
      }
      function updateStepPlayerPhaseYear(data) {
        moveCounter += 1;
        //console.log(moveCounter, ": gameloop");
        if ("game" in data) {
          year = Number(data.game.year);
          phase = data.game.phase;

          //handle player change
          if (data.game.player != player) {
            player = data.game.player;
          }

          statusMessage();
        } else {
          console.log("data:", data);
          statusMessage("EDIT MODE!");
          //error("updateStepPlayerPhaseYear: MISSING GAME DATA!!!");
        }
      }
      function updateLog(data) {
        if ("log" in data && !empty(data.log)) {
          let d = document.getElementById("log_area");
          let para = document.createElement("p");
          para.innerHTML = data.log;
          d.appendChild(para);
          para.scrollIntoView();
        }
      }
    </script>
    <!-- #endregion control flow -->

    <!-- #region globals -->
    <script>
      var G = {}; //package up all game state info
      var player; //22 steps
      var year = 1935;
      var phase = "Setup";
      var gameObjects = {}; //all created objects in play, ids same as server ids
      var nextAction = null;
      var serverData = null;
      var tuples = [];

      //control flow and console output flags
      var defaultSkipCond = () => !execOptions.manualPlay.includes(player);
      var execOptions = {
        mode: "game", // 'game' || 'edit'
        outputLevel: 0, // (see testOutput: )
        playerChange: "auto", // 'auto' | 'manual'
        skipCond: defaultSkipCond, //!execOptions.manualPlay.includes(player), // predicate func evaluating to cond for autoplay
        manualPlay: ["Axis", "West", "USSR"],
        activatedTests: [] // unitTest flags to control output
      };
      var moveCounter = 0; //sendaction counts as a move (also player change)
      var STOP = false; //to interrupt autoplay
      //var isUIFrozen = true; //no user interaction during sending and autoplay

      //test: if (execOptions.skipCond()){console.log('ja das functioniert sehr gut sogar')}

      var sender = new ASender(execOptions);
      var assets = new NAssets();
      var page = new NPage().initView().selectView();

      var map = new AMap(assets); //responsible for tile influence nation chip
      var cards = new ACards(assets);
      var units = new AUnits(assets);
      var decider = new ADecisiongen(assets); //responsible for move generation

      panzoom("mapG"); //handles pan zoom on map
      $(document).ready(function() {
        assets.initAssets(map, startScript);
      });
    </script>
    <!-- #endregion globals -->

    <!-- #region execution starts here! -->
    <script>
      function startScript() {
        //addIf("control", execOptions.activatedTests);
        //addIf("units", execOptions.activatedTests);
        addIf("moving", execOptions.activatedTests);

        testMovement();
        // addIf("removed", execOptions.activatedTests);
        // player = "Axis";
        // sendInit(player, gameloop, 5);

        //bei seed = 4: kommt nur influence von <= 2 zustande!
        //bei seed = 1: geht nicht, in gov phase kommt fehler: USA cannot become satellite of Axis
        //try seed = 2: nur <= 2
        //try seed = 3: usa becoming satellite of Axis! mit West kommt nicht ueber 1

        //player = "USSR";
        //testEditModeCreateUnit();

        //testControlFlow(player);
        // testInitToEnd(player,4); //ok
        // testLoadToEnd('Axis','prod_complete'); //ok
        // testCreateSingleUnit(); //ok
        // testCreateMultipleUnitsOnSameTile(); //ok
        // testIntegrationUnits(); //ok
        // testIntegrationMap(); //ok
        // testCreateOneCard(); //ok
        // testCreateNCards(); //ok
        // testIntegrationCards(); //ok
      }
    </script>
    <!-- #endregion execution -->
  </body>
</html>
