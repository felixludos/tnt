<!DOCTYPE html>
<html>
  <head>
    <title>a94</title>
    <link rel="shortcut icon" href="#" />
    <link rel="stylesheet" type="text/css" href="/a/css/autocomp.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/main.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/layout.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/msStyles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.2/js-yaml.js"></script>

    <script src="/a/js/ASender.js"></script>
    <script src="/a/js/NAssets.js"></script>
    <script src="/a/js/helpers.js"></script>
    <script src="/a/js/panzoom.js"></script>
    <script src="/a/js/MS.js"></script>
    <script src="/a/js/NPage.js"></script>
    <script src="/a/js/AMap.js"></script>
    <script src="/a/js/ACards.js"></script>
    <script src="/a/js/AUnits.js"></script>
    <script src="/a/js/unitTests.js"></script>
  </head>
  <body>
    <!-- #region HTML -->
    <div id="mainDiv" class="grid_game">
      <div id="menu_area" class="grid_div" style="text-align:left;">
        <div style="float:left;margin-left:10px">
          <button class="hidden" id="bLoadScenario" onclick="onClickLoadScenario()">load scenario</button>
          <button class="hidden" id="bStartScenario" onclick="onClickStartScenario()">start scenario</button>
          <button class="hidden" id="bSkipAction" onclick="onClickSkipAction()">skip action</button>
        </div>
        <div style="float:right;margin-right:10px">
          view:
          <button id="bViewGame" onclick="page.gameView()">game</button>
          <button class="hidden" id="bViewNoReserve" onclick="page.gameView(false)">no reserve</button>
          <button id="bViewEdit" onclick="page.editView()">edit</button>
          <button id="bViewTest" onclick="page.testView()">test</button>
        </div>
      </div>
      <div id="status_area" class="grid_div" onclick="page.testView()">status</div>
      <div id="test_area" class="grid_div">
        <div class="flexdiv">
          <div class="autocomplete">
            <input id="myInput" type="text" name="myCountry" style="font-size:30px;" placeholder="command" />
          </div>
          <div class="autocomplete">
            <input id="inparam" type="text" name="inparam" style="font-size:30px;" placeholder="param" />
          </div>
          <button style="margin:10px" id="bSendMessage" onclick="onClickSendMessage()">send message</button>
          <button style="margin:10px" id="bClear" onclick="onClickClearInputs()">clear inputs</button>
        </div>
        <div style="margin:10px;text-align:left;">
          <!-- <input type="text" id="inAction" style="width:90%;font-size:30px;" placeholder="enter action"> -->
          <button id="bAddUnit" onclick="onClickAddUnit()">add unit</button>
        </div>
      </div>
      <div id="reserve_area" class="grid_div">
        <svg id="selSvg" width="60" height="760"><g id="reserveG"></g></svg>
      </div>
      <div id="map_area" class="grid_div" style="background-color:rgba(86, 182, 222);">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="mapG" viewBox="0 0 3400 2200">
            <image id="imgMap" width="3400" height="2200" href="/assets/TTmap.jpg" />
          </g>
        </svg>
      </div>
      <div id="log_area" class="grid_div" style="max-height:760px;overflow-y:scroll">
        <div id="log_all" class="hidden">all messages</div>
        <div id="log_Axis" class="hidden">Axis messages</div>
        <div id="log_USSR" class="hidden">USSR messages</div>
        <div id="log_West" class="hidden">West messages</div>
        <div id="tempDisplay" class="hidden" style="width:100%;height:100%">
          <svg width="100%" height="100%" style="box-sizing:border-box;">
            <g id="tempG"></g>
          </svg>
        </div>
      </div>
      <div id="prop_area" class="grid_div hidden">
        actions
        <button id="bEditPlaceUnits" onclick="onClickEditPlaceUnits(this)">place unit</button>
        <button id="bEditDrawCards" onclick="onClickEditDrawCards(this)">draw card</button>
        <button id="bEditDeleteUnits" onclick="onClickEditDeleteUnits(this)">delete unit</button>
        <button id="bEditDeleteCards" onclick="onClickEditDeleteCards(this)">delete card</button>
        <button id="bEditDeleteAll" onclick="onClickEditDeleteAll(this)">delete all</button>
        <button id="bEditNextPlayer" onclick="onClickEditNextPlayer(this)">next player</button>
        <button id="bEditDone" onclick="onClickEditDone(this)">done</button>
      </div>
      <div id="command_area" class="grid_div">
        <div class="columnDiv">
          <!-- <button id="bNextPlayer" class="hidden" style="width:90%;" onclick="onClickNextPlayer()">next player</button> -->
          <button class="chrome" id="bStop" style="background-color:red" onclick="onClickStop()">STOP</button>
          <button class="chrome" id="bStep" onclick="onClickStep()">step</button>
          <label class="chrome" for="inYear">year</label>
          <input class="chrome" type="text" id="inYear" />
          <label class="chrome" for="inPhase">phase</label>
          <input class="chrome" type="text" id="inPhase" />
          <label class="chrome" for="inPhase">player</label>
          <input class="chrome" type="text" id="inPlayer" />
          <label class="chrome" for="inStep">step</label>
          <input class="chrome" type="text" id="inStep" />
          <button class="chrome" id="bGo" onclick="onClickGo()">go</button>
        </div>
      </div>
      <div id="chat_area" class="grid_div hidden">chat</div>
      <div id="hand_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="handG_Axis"><text x="10" y="25" fill="grey">Axis</text></g>
          <g id="handG_USSR"><text x="10" y="25" fill="red">USSR</text></g>
          <g id="handG_West"><text x="10" y="25" fill="blue">West</text></g>
        </svg>
      </div>
      <div id="cards2_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="openCardG"><text x="10" y="25" fill="grey">open</text></g>
          <g id="actionDeckG"><text x="10" y="25" fill="grey">action</text></g>
        </svg>
      </div>
      <div id="cards3_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="discardedG"><text x="10" y="25" fill="grey">discarded</text></g>
          <g id="investmentDeckG"><text x="10" y="25" fill="grey">investment</text></g>
        </svg>
      </div>
    </div>
    <!-- #endregion HTML -->

    <!-- #region handlers -->
    <script>
      function onClickStop() {
        STOP = true;
      }
      function onClickGo() {
        inputsToOptions();
        console.log("options:", execOptions.skipTo);
        step = 0;
        STOP = false;
        callNextAction();
      }
      function onClickStep() {
        STOP = false;
        callNextAction();
      }
      function onClickNextPlayer() {
        hide(bNextPlayer);
        callNextAction();
      }
    </script>
    <!-- #endregion handlers -->

    <!-- #region helpers -->
    <script>
      function activateButtons() {
        show(bStep);
        show(bGo);
      }
      function deactivateButtons() {
        hide(bStep);
        hide(bGo);
      }
    </script>
    <!-- #endregion helpers -->

    <!-- #region _work -->
    <script>

      function present(data) {
        if (isPlayerChanging) {
          isPlayerChanging = false;
          page.updateGameView(player, execOptions);
        }

        updateUI(data);

        processActions(data);
      }
      function updateUI(data) {
        updateStatus(data);
        updateLog(data);
        updateGameObjects(data);
        map.update(data, gameObjects);
        cards.update(data, gameObjects);
      }
      function updateGameObjects(data) {
        //augment gameObjects by all created and updated objects
        if ("created" in data) {
          jQuery.extend(true, gameObjects, data.created);
        }
        if ("updated" in data) {
          jQuery.extend(true, gameObjects, data.updated);
        }
        if ("removed" in data) {
          for (const id in data.removed) {
            delete gameObjects[id];
          }
        }
      }
      function updateLog(data) {
        if ("log" in data && !empty(data.log)) {
          let id = execOptions.log == "individual" ? "log_" + player : "log_all";
          let d = document.getElementById(id);
          let para = document.createElement("p");
          para.innerHTML = data.log;
          d.appendChild(para);
          para.scrollIntoView();
        }
      }
      function updateStatus(data) {
        if ("game" in data) {
          year = Number(data.game.year);
          phase = data.game.phase;
          player = data.game.player;
          statusMessage();
        }
      }

      function processActions(data) {
        step += 1;
        let tuples = getTuples(data);

        console.assert(tuples.length > 0 || "waiting_for" in data, "ASSERTION FAIL!!! no action or waiting_for!!!!");

        if (empty(tuples)) {
          let msgAfter = "...waiting for player change!";

          if (execOptions.output == "endToEnd") {
            logFormattedData(data, msgCounter, msgAfter);
            msgCounter += 1;
          }

          nextAction = () => sendChangePlayer(data, present);
          isPlayerChanging = true;
        } else {
          let tuple = chooseNthNonPassTuple(tuples, choiceIndex);
          choiceIndex = (choiceIndex + 1) % choiceModulo;
          let msgAfter = player + " chooses " + tuple.toString();

          if (execOptions.output == "endToEnd") {
            logFormattedData(data, msgCounter, msgAfter);
            msgCounter += 1;
          }

          nextAction = () => sendAction(player, tuple, present);
        }

        checkProceedCondition();
      }
      function callNextAction() {
        if (nextAction) {
          deactivateButtons();
          nextAction();
        }
      }
      function checkProceedCondition() {
        //skipTo: {year:'1935',phase:'production',player:'any',step:0},
        if (execOptions.mode == "skipTo") {
          let opt = execOptions.skipTo;
          let nYear = Number(year);
          let skipAhead = isWrongPhase() || isTooEarly() || isWrongPlayer();
          if (skipAhead) {
            callNextAction();
          } else {
            activateButtons();
          }
        }
      }
    </script>
    <!-- #endregion _work -->

    <script>
      var player = "Axis"; //22 steps
      var year = 1935;
      var phase = "Setup";
      var step = 0; // if step==0 take every step, otherwise skip step steps.

      // determinism
      var choiceIndex = 0;
      var choiceModulo = 3;
      var msgCounter = 0;
      var seed = 1;

      //control flow;
      var execOptions = {
        output: "none", // 'fine' | 'endToEnd' | 'manual' | 'none'
        playerChange: "auto", // 'auto' | 'manual'
        log: "general", // 'general' | 'individual'
        mode: "skipTo", // 'step' | 'continuous' | 'nskip' | 'skipTo'
        skipTo: {year: 1935, phase: "p", player: "u", step: 0}
      };
      optionsToInputs();
      var nextAction = null;
      var STOP = false; //interrupt endless play
      var isPlayerChanging = true;

      //data
      var gameObjects = {}; //all created objects in play, ids same as server ids
      var serverData; //not used right now

      //initialization
      var sender = new ASender(execOptions);
      //sender.send('initWest');
      var assets = new NAssets();
      var page = new NPage()
        .initView()
        .gameView()
        .updateGameView(player, execOptions); //handles layout
      panzoom("mapG"); //handles pan zoom on map
      map = new AMap(assets); //responsible for tile influence nation chip
      cards = new ACards(assets);
      var chain = ["init/hotseat/" + player + "/" + seed, "info/" + player, "status/" + player];
      assets.initAssets(map, () => sender.chainSend(chain, player, present));
    </script>
  </body>
</html>
