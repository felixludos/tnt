<!DOCTYPE html>
<html>
  <head>
    <title>a94</title>
    <link rel="shortcut icon" href="#" />
    <link rel="stylesheet" type="text/css" href="/a/css/selectStyle.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/autocomp.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/main.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/layout.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/msStyles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.2/js-yaml.js"></script>

    <script src="/a/js/ASender.js"></script>
    <script src="/a/js/NAssets.js"></script>
    <script src="/a/js/unitTestIOHelpers.js"></script>
    <script src="/a/js/helpers.js"></script>
    <script src="/a/js/panzoom.js"></script>
    <script src="/a/js/MS.js"></script>
    <script src="/a/js/NPage.js"></script>
    <script src="/a/js/AMap.js"></script>
    <script src="/a/js/AHand.js"></script>
    <script src="/a/js/ACards.js"></script>
    <script src="/a/js/AUnits.js"></script>
    <script src="/a/js/ADecisiongen.js"></script>
    <script src="/a/js/unitTests.js"></script>
  </head>
  <body>
    <!-- #region HTML -->
    <div id="mainDiv" class="grid_game">
      <div id="status_area" class="grid_div">
        <div id="status_info" style="float:right;margin-right:10px;"></div>
        <div id="ui_control" style="float:left;text-align:left;margin-left:10px;">
          <div id="dFrozen" style="color:darkviolet;">wait...</div>
          <div id="dAutoplay" class="hidden" style="color:red;">
            autoplay...
            <button id="bStop" style="color:white;background-color:red" onclick="onClickStop()">STOP</button>
          </div>
          <div id="dActive" class="hidden" style="color:rgb(0, 104, 0);">Select Action:</div>
          <button id="bNextPlayer" class="hidden" style="color:green;" onclick="onClickNextPlayer()">Next Player</button>
        </div>
        <div id="status_message"></div>
      </div>
      <div id="map_area" class="grid_div" style="background-color:rgba(86, 182, 222);">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="mapG" viewBox="0 0 3400 2200">
            <image id="imgMap" width="3400" height="2200" href="/a/assets/TTmap.jpg" />
          </g>
        </svg>
      </div>
      <div id="select_area" class="grid_div">
        <div id="divSelect" class="sidenav"></div>
      </div>
      <div id="command_area" class="grid_div">
        <div id="uiActiveButtons" class="hidden" >
          <button id="bStep" onclick="decider.onClickStep()">step</button>
          <button id="bRunToEnd" onclick="onClickRunToEnd()">run to end</button>
          <!-- <button id="bPlayWest" onclick="onClickPlay(this)">play West</button>
          <button id="bPlayUSSR" onclick="onClickPlay(this)">play USSR</button>
          <button id="bPlayAxis" onclick="onClickPlay(this)">play Axis</button> -->
          <button id="bRestart" style='margin-top:24px;background-color:orangered;' onclick="onClickRestart(this)">restart</button>
        </div>
      </div>
      <div id="log_area" class="grid_div" style="max-height:760px;overflow-y:scroll"></div>
      <div id="hand_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="handG_Axis" style="visibility:hidden"><text x="10" y="25" fill="grey">Axis</text></g>
          <g id="handG_USSR" style="visibility:hidden"><text x="10" y="25" fill="red">USSR</text></g>
          <g id="handG_West" style="visibility:hidden"><text x="10" y="25" fill="blue">West</text></g>
        </svg>
      </div>
      <div id="cards2_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="openCardG"><text x="10" y="25" fill="grey">open</text></g>
          <g id="actionDeckG"><text x="10" y="25" fill="grey">action</text></g>
        </svg>
      </div>
      <div id="cards3_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="discardedG"><text x="10" y="25" fill="grey">discarded</text></g>
          <g id="investmentDeckG"><text x="10" y="25" fill="grey">investment</text></g>
        </svg>
      </div>
    </div>
    <!-- #endregion HTML -->

    <!-- #region UI / handlers -->
    <script>
      function activateWaitingForServer() {
        show(document.getElementById("dFrozen"));
        hide(document.getElementById("dAutoplay"));
        hide(document.getElementById("dActive"));
        hide(document.getElementById("uiActiveButtons"));
        hide(document.getElementById("bNextPlayer"));
      }
      function activateNextPlayerButton() {
        hide(document.getElementById("dFrozen"));
        hide(document.getElementById("dAutoplay"));
        hide(document.getElementById("dActive"));
        hide(document.getElementById("uiActiveButtons"));
        show(document.getElementById("bNextPlayer"));
      }
      function activateUserSelection() {
        hide(document.getElementById("dFrozen"));
        hide(document.getElementById("dAutoplay"));
        show(document.getElementById("dActive"));
        show(document.getElementById("uiActiveButtons"));
        hide(document.getElementById("bNextPlayer"));
      }
      function activateAutoplay() {
        hide(document.getElementById("dFrozen"));
        show(document.getElementById("dAutoplay"));
        hide(document.getElementById("dActive"));
        hide(document.getElementById("uiActiveButtons"));
        hide(document.getElementById("bNextPlayer"));
      }
      function callNextAction() {
        if (nextAction) {
          activateWaitingForServer();
          nextAction();
        } else {
          error("NO NEXT ACTION!!!!!!!");
        }
      }
      function onClickNextPlayer() {
        callNextAction();
      }
      function onClickRunToEnd() {
        STOP = false;
        execOptions.manualPlay = [];//skipCond = () => true;
        decider.onClickStep();
      }
      function onClickPlay(b) {
        // do not restart, just change role: execOptions.skipCond
        //b.classList.add('selected')
        //was ich will wenn einer auch playWest clicked:
        //toggle 

        let pl = stringAfter(b.id,'Play');
        //toggle this player 
        console.log('before toggle',execOptions.manualPlay.toString());
        console.log(execOptions.skipCond);
        if (execOptions.manualPlay.includes(pl)){
          console.log('player',pl,'is in manualPlay!')
          removeInPlace(execOptions.manualPlay,pl);
          console.log(execOptions.manualPlay);
          b.classList.remove('toggleSelected');
        } else{
          console.log('player',pl,'is NOT in manualPlay!')
          execOptions.manualPlay.push(pl);
          b.classList.add('toggleSelected');
        }
        console.log('after toggle',execOptions.manualPlay.toString());
        console.log(execOptions.skipCond, player);
        STOP=false;
        decider.onClickStep();
      }
      function onClickRestart(){
        //restart with random player, do NOT change role!
        let pl = chooseRandom(assets.factionNames);
        console.log('restarting with',pl,assets.factionNames.toString());
        restart(pl);
      }
      function onClickStop() {
        unitTestControl("*** onClickStop!!! ***");
        STOP = true;
      }
      function statusMessage(msg = "") {
        let s = "Phase:" + phase + ", Year:" + year + ", Player:" + player;
        document.getElementById("status_info").innerHTML = s;
        if (!empty(msg)) document.getElementById("status_message").innerHTML = msg;
      }
    </script>
    <!-- #endregion handlers -->

    <!-- #region control flow -->
    <script>
      function gameloop(data) {
        //update
        unitTestControl("*** gameloop: updating ***");
        updateStepPlayerPhaseYear(data);
        updateLog(data);
        mergeCreatedAndUpdated(data);
        cards.update(player, data, gameObjects);
        map.update(data, gameObjects);
        units.update(data, gameObjects, player);

        //next action
        let tuples = getTuples(data);

        //player change if no actions OR decide next action
        if (empty(tuples)) {
          let waitingSet = getSet(data, "waiting_for");
          if (empty(waitingSet)) {
            unitTestControl("*** gameloop: sending empty action ***");
            sendEmptyAction(player, callback);
          } else {
            unitTestControl("*** gameloop: setting nextAction to sendChangeToPlayer ***");
            nextAction = () => sendChangeToPlayer(waitingSet[0], gameloop);

            //player change manual or automatic:
            if (execOptions.playerChange == "auto") callNextAction();
            else show(bNextPlayer);
          }
        } else {
          //actions: decider generates a move:
          let autoplay = execOptions.skipCond() && !STOP;
          if (autoplay) activateAutoplay();
          else activateUserSelection();
          unitTestControl("*** gameloop: calling decider.genMove ***");
          unitTestControl("autoplay:",autoplay,'player',player);
          decider.genMove(tuples, t => sendAction(player, t, gameloop), autoplay);
        }
        window.scrollTo(0, 0);
      }
      function restart(pl, filename = "") {
        player = pl;
        year = 1935;
        phase = "Setup";
        gameObjects = {};
        nextAction = null;
        moveCounter = 0;
        STOP = false;
        sender = new ASender(execOptions);

        page.clearAllObjects();
        map = new AMap(assets);
        cards = new ACards(assets);
        units = new AUnits(assets);
        decider = new ADecisiongen(assets);
        if (empty(filename)) sendInit(player, gameloop, 0);
        else sendLoading(filename, player, gameloop);
      }
      function updateStepPlayerPhaseYear(data) {
        moveCounter += 1;
        if ("game" in data) {
          year = Number(data.game.year);
          phase = data.game.phase;

          //handle player change
          if (data.game.player != player) {
            player = data.game.player;
          }

          statusMessage();
        } else {
          error("updateStepPlayerPhaseYear: MISSING GAME DATA!!!");
        }
      }
      function updateLog(data) {
        if ("log" in data && !empty(data.log)) {
          let d = document.getElementById("log_area");
          let para = document.createElement("p");
          para.innerHTML = data.log;
          d.appendChild(para);
          para.scrollIntoView();
        }
      }
    </script>
    <!-- #endregion control flow -->

    <!-- #region globals -->
    <script>
      var player = "Axis"; //22 steps
      var year = 1935;
      var phase = "Setup";
      var gameObjects = {}; //all created objects in play, ids same as server ids
      var nextAction = null;

      //control flow and console output flags
      var execOptions = {
        outputLevel: 0, // (see testOutput: )
        playerChange: "auto", // 'auto' | 'manual'
        skipCond: () => !execOptions.manualPlay.includes(player), // predicate func evaluating to cond for autoplay
        manualPlay: [],
        activatedTests: [] // unitTest flags to control output
      };
      var moveCounter = 0; //sendaction counts as a move (also player change)
      var STOP = false; //to interrupt autoplay
      //var isUIFrozen = true; //no user interaction during sending and autoplay

      //test: if (execOptions.skipCond()){console.log('ja das functioniert sehr gut sogar')}

      var sender = new ASender(execOptions);
      var assets = new NAssets();
      var page = new NPage().initView().selectView();

      var map = new AMap(assets); //responsible for tile influence nation chip
      var cards = new ACards(assets);
      var units = new AUnits(assets);
      var decider = new ADecisiongen(assets); //responsible for move generation

      panzoom("mapG"); //handles pan zoom on map
      $(document).ready(function() {
        assets.initAssets(map, startScript);
      });
    </script>
    <!-- #endregion globals -->

    <!-- #region execution starts here! -->
    <script>
      function startScript() {
        //sendInit(player, gameloop, 4);
        testControlFlow(player);
        // testInitToEnd(player,4); //ok
        // testLoadToEnd('Axis','prod_complete'); //ok
        // testCreateSingleUnit(); //ok
        // testCreateMultipleUnitsOnSameTile(); //ok
        // testIntegrationUnits(); //ok
        // testIntegrationMap(); //ok
        // testCreateOneCard(); //ok
        // testCreateNCards(); //ok
        // testIntegrationCards(); //ok
      }
    </script>
    <!-- #endregion execution -->
  </body>
</html>
