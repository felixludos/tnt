<!DOCTYPE html>
<html>
  <head>
    <title>a94</title>
    <link rel="shortcut icon" href="#" />
    <link rel="stylesheet" type="text/css" href="/a/css/autocomp.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/main.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/layout.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/msStyles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.2/js-yaml.js"></script>

    <script src="/a/js/ASender.js"></script>
    <script src="/a/js/NAssets.js"></script>
    <script src="/a/js/unitTestIOHelpers.js"></script>
    <script src="/a/js/helpers.js"></script>
    <script src="/a/js/panzoom.js"></script>
    <script src="/a/js/MS.js"></script>
    <script src="/a/js/NPage.js"></script>
    <script src="/a/js/AMap.js"></script>
    <script src="/a/js/AHand.js"></script>
    <script src="/a/js/ACards.js"></script>
    <script src="/a/js/AUnits.js"></script>
    <script src="/a/js/ADecider.js"></script>
    <script src="/a/js/unitTests.js"></script>
  </head>
  <body>
    <!-- #region HTML -->
    <div id="mainDiv" class="grid_game">
      <div id="menu_area" class="grid_div" style="text-align:left;">
        <div style="float:left;margin-left:10px">
          <button class="hidden" id="bLoadScenario" onclick="onClickLoadScenario()">load scenario</button>
          <button class="hidden" id="bStartScenario" onclick="onClickStartScenario()">start scenario</button>
          <button class="hidden" id="bSkipAction" onclick="onClickSkipAction()">skip action</button>
        </div>
        <div style="float:right;margin-right:10px">
          view:
          <button id="bViewGame" onclick="page.gameView()">game</button>
          <button class="hidden" id="bViewNoReserve" onclick="page.gameView(false)">no reserve</button>
          <button id="bViewEdit" onclick="page.editView()">edit</button>
          <button id="bViewTest" onclick="page.testView()">test</button>
        </div>
      </div>
      <div id="status_area" class="grid_div" onclick="page.testView()">status</div>
      <div id="test_area" class="grid_div">
        <div class="flexdiv">
          <div class="autocomplete">
            <input id="myInput" type="text" name="myCountry" style="font-size:30px;" placeholder="command" />
          </div>
          <div class="autocomplete">
            <input id="inparam" type="text" name="inparam" style="font-size:30px;" placeholder="param" />
          </div>
          <button style="margin:10px" id="bSendMessage" onclick="onClickSendMessage()">send message</button>
          <button style="margin:10px" id="bClear" onclick="onClickClearInputs()">clear inputs</button>
        </div>
        <div style="margin:10px;text-align:left;">
          <!-- <input type="text" id="inAction" style="width:90%;font-size:30px;" placeholder="enter action"> -->
          <button id="bAddUnit" onclick="onClickAddUnit()">add unit</button>
        </div>
      </div>
      <div id="reserve_area" class="grid_div">
        <svg id="selSvg" width="60" height="760"><g id="reserveG"></g></svg>
      </div>
      <div id="map_area" class="grid_div" style="background-color:rgba(86, 182, 222);">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="mapG" viewBox="0 0 3400 2200">
            <image id="imgMap" width="3400" height="2200" href="/a/assets/TTmap.jpg" />
          </g>
        </svg>
      </div>
      <div id="log_area" class="grid_div" style="max-height:760px;overflow-y:scroll">
        <div id="log_all" class="hidden">all messages</div>
        <div id="log_Axis" class="hidden">Axis messages</div>
        <div id="log_USSR" class="hidden">USSR messages</div>
        <div id="log_West" class="hidden">West messages</div>
        <div id="tempDisplay" class="hidden" style="width:100%;height:100%">
          <svg width="100%" height="100%" style="box-sizing:border-box;">
            <g id="tempG"></g>
          </svg>
        </div>
      </div>
      <div id="prop_area" class="grid_div hidden">
        actions
        <button id="bEditPlaceUnits" onclick="onClickEditPlaceUnits(this)">place unit</button>
        <button id="bEditDrawCards" onclick="onClickEditDrawCards(this)">draw card</button>
        <button id="bEditDeleteUnits" onclick="onClickEditDeleteUnits(this)">delete unit</button>
        <button id="bEditDeleteCards" onclick="onClickEditDeleteCards(this)">delete card</button>
        <button id="bEditDeleteAll" onclick="onClickEditDeleteAll(this)">delete all</button>
        <button id="bEditNextPlayer" onclick="onClickEditNextPlayer(this)">next player</button>
        <button id="bEditDone" onclick="onClickEditDone(this)">done</button>
      </div>
      <div id="command_area" class="grid_div">
        <!-- <div > -->
        <!-- <button id="bNextPlayer" class="hidden" style="width:90%;" onclick="onClickNextPlayer()">next player</button> -->
        <button class="chrome" id="bStop" style="background-color:red" onclick="onClickStop()">STOP</button>
        <button class="chrome" id="bStep" onclick="onClickStep()">step</button>

        <p style="margin:2px 5px">SkipTo:</p>
        <input id="rYear" type="radio" name="skipTo" value="year" />
        <label for="rYear">year</label>
        <br />
        <input type="radio" name="skipTo" value="phase" />
        phase
        <br />
        <input type="radio" name="skipTo" value="player" />
        player
        <br />
        <input type="radio" name="skipTo" value="step" />
        step
        <br />
        <input class="chrome" type="text" id="inSkipTo" name="inSkipTo" />

        <p style="margin:2px 5px">Output:</p>
        <input class="chrome" type="number" id="inOutput" value="0" />

        <!-- <label class="chrome" for="inYear">year</label>
          <input class="chrome" type="text" id="inYear" />
          <label class="chrome" for="inPhase">phase</label>
          <input class="chrome" type="text" id="inPhase" />
          <label class="chrome" for="inPhase">player</label>
          <input class="chrome" type="text" id="inPlayer" />
          <label class="chrome" for="inStep">step</label>
          <input class="chrome" type="text" id="inStep" /> -->
        <button class="chrome" id="bGo" onclick="onClickGo()">go</button>
        <!-- </div> -->
      </div>
      <div id="chat_area" class="grid_div hidden">chat</div>
      <div id="hand_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="handG_Axis"><text x="10" y="25" fill="grey">Axis</text></g>
          <g id="handG_USSR"><text x="10" y="25" fill="red">USSR</text></g>
          <g id="handG_West"><text x="10" y="25" fill="blue">West</text></g>
        </svg>
      </div>
      <div id="cards2_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="openCardG"><text x="10" y="25" fill="grey">open</text></g>
          <g id="actionDeckG"><text x="10" y="25" fill="grey">action</text></g>
        </svg>
      </div>
      <div id="cards3_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="discardedG"><text x="10" y="25" fill="grey">discarded</text></g>
          <g id="investmentDeckG"><text x="10" y="25" fill="grey">investment</text></g>
        </svg>
      </div>
    </div>
    <!-- #endregion HTML -->

    <!-- #region UI / handlers -->
    <script>
      function activateButtons() {
        show(bStep);
        show(bGo);
      }
      function deactivateButtons() {
        hide(bStep);
        hide(bGo);
      }
      function inputsToOptions() {
        let key = document.querySelector('input[name="skipTo"]:checked').value;
        let val = document.getElementById("inSkipTo").value;
        let opt = {};
        opt[key] = val;
        setSkipOptions(opt);
        execOptions.outputLevel = document.getElementById("inOutput").value;

        // execOptions.skipTo.year = document.getElementById("inYear").value;
        // execOptions.skipTo.phase = document.getElementById("inPhase").value;
        // execOptions.skipTo.player = document.getElementById("inPlayer").value;
        // execOptions.skipTo.step = document.getElementById("inStep").value;
      }
      function optionsToInputs() {
        var opt = document.getElementsByName("skipTo");
        //var selectedSkipTo;

        var nonDefault =
          execOptions.skipTo.step != 0
            ? {k: "step", v: execOptions.skipTo.step}
            : execOptions.skipTo.player != "any"
            ? {k: "player", v: execOptions.skipTo.player}
            : execOptions.skipTo.phase != "any"
            ? {k: "phase", v: execOptions.skipTo.phase}
            : execOptions.skipTo.year != 1935
            ? {k: "year", v: execOptions.skipTo.year}
            : {k: "step", v: 0};

        //console.log('optionsToInputs nonDefault',nonDefault);
        for (var i = 0; i < opt.length; i++) {
          //console.log(opt[i]);
          if (opt[i].value == nonDefault.k) {
            opt[i].checked = true;
          } else {
            opt[i].checked = false;
          }
          //console.log('opt[i].value',opt[i].value,'nonDefault.k',nonDefault.k,'opt[i].checked',opt[i])
          //if (opt[i].checked) selectedSkipTo = opt[i].value;
        }
        document.getElementById("inSkipTo").value = nonDefault.v;

        document.getElementById("inOutput").value = execOptions.outputLevel;

        // document.getElementById("inYear").value = execOptions.skipTo.year;
        // document.getElementById("inPhase").value = execOptions.skipTo.phase;
        // document.getElementById("inPlayer").value = execOptions.skipTo.player;
        // document.getElementById("inStep").value = execOptions.skipTo.step;
      }
      function setSkipOptions(opt = {year: 1935, player: "any", phase: "any", step: 0}) {
        execOptions.skipTo = {year: 1935, player: "any", phase: "any", step: 0}; // {year: year, player: player, phase: phase, step: step};
        for (const key in opt) {
          const element = opt[key];
          execOptions.skipTo[key] = element;
        }
        optionsToInputs();
      }
      function onClickStop() {
        STOP = true;
        activateButtons();
      }
      function onClickGo() {
        inputsToOptions();
        //console.log("options:", execOptions.skipTo);
        step = 0;
        STOP = false;
        callNextAction();
      }
      function onClickStep() {
        step = execOptions.skipTo.step;
        STOP = false;
        callNextAction();
      }
      function onClickNextPlayer() {
        hide(bNextPlayer);
        callNextAction();
      }
    </script>
    <!-- #endregion handlers -->

    <!-- #region control flow -->
    <script>
      function callNextAction() {
        if (nextAction) {
          deactivateButtons();
          nextAction();
        }
      }
      function checkProceedCondition() {
        if (STOP) {
          return;
        } else if (execOptions.mode == "skipTo") {
          let opt = execOptions.skipTo;
          let nYear = Number(year);
          let skipAhead = isWrongPhase() || isTooEarly() || isWrongPlayer();
          if (skipAhead) {
            callNextAction();
          } else {
            activateButtons();
            //console.log("press step to send choice to server!");
          }
        }
      }
      function gameloop(data) {
        step += 1;

        updatePlayerPhaseYear(data);
        updateLog(data);
        mergeCreatedAndUpdated(data);
        cards.update(player, data, gameObjects);
        map.update(data, gameObjects);
        units.update(data, gameObjects, player);

        let tuples = getTuples(data);

        if (empty(tuples)) {
          prepareForPlayerChange(data, gameloop); //player change is next
        } else {
          decider.pickTuple(tuples, t => prepareForSendAction(t, gameloop));
        }
      }
      function prepareForPlayerChange(data, callback) {
        let waitingSet = getSet(data, "waiting_for");
        if (empty(waitingSet)) {
          sendEmptyAction(player, callback);
        } else {
          nextAction = () => {
            sendChangeToPlayer(waitingSet[0], callback);
          };
          checkProceedCondition(); //auto next move or show buttons
        }
      }
      function prepareForSendAction(tuple, callback) {
        nextAction = () => {
          sendAction(player, tuple, callback);
        };
        checkProceedCondition(); //auto next move or show buttons
      }
      function updatePlayerPhaseYear(data) {
        if ("game" in data) {
          year = Number(data.game.year);
          phase = data.game.phase;

          //handle player change
          if (data.game.player != player) {
            player = data.game.player;
            page.updateGameView(player, execOptions);
          }

          statusMessage();
        }
      }
      function updateLog(data) {
        if ("log" in data && !empty(data.log)) {
          let id = execOptions.log == "individual" ? "log_" + player : "log_all";
          let d = document.getElementById(id);
          let para = document.createElement("p");
          para.innerHTML = data.log;
          d.appendChild(para);
          para.scrollIntoView();
        }
      }
    </script>
    <!-- #endregion control flow -->

    <!-- #region globals -->
    <script>
      var player = "Axis"; //22 steps
      var year = 1935;
      var phase = "Setup";
      var gameObjects = {}; //all created objects in play, ids same as server ids
      var nextAction = null;

      //control flow;
      var execOptions = {
        output: "none", // 'fine' | 'endToEnd' | 'manual' | 'none' | 'raw'
        outputLevel: 0, // priority output (see testOutput)
        playerChange: "auto", // 'auto' | 'manual'
        log: "general", // 'general' | 'individual'
        mode: "skipTo", // 'step' | 'continuous' | 'nskip' | 'skipTo'
        skipTo: {year: 1935, phase: "any", player: "any", step: 10},
        activatedTests: [] // unitTest flags to control output
      };
      var step = 0;
      var STOP = false;

      var sender = new ASender(execOptions);
      var assets = new NAssets();
      var page = new NPage()
        .initView()
        .gameView()
        .updateGameView(player, execOptions); //handles layout

      var map = new AMap(assets); //responsible for tile influence nation chip
      var cards = new ACards(assets);
      var units = new AUnits(assets);
      var decider = new ADecider(assets); //responsible for tuple selection

      $(document).ready(function() {
        optionsToInputs();
        panzoom("mapG"); //handles pan zoom on map
        assets.initAssets(map, startScript);
      });
    </script>
    <!-- #endregion globals -->

    <!-- #region execution -->
    <script>
      function startScript() {
        
        //sendInit(player, gameloop, 4);

        //testInitToEnd(player,4); //ok
        //testLoadToEnd('Axis','prod_complete'); //ok
        
        //testCreateSingleUnit(); //ok
        //testCreateMultipleUnitsOnSameTile(); //ok
        //testIntegrationUnits(); //ok

        // testIntegrationMap(); //ok

        // testCreateOneCard(); //ok
        // testCreateNCards(); //ok
        // testIntegrationCards(); //ok

      }
    </script>
    <!-- #endregion execution -->
  </body>
</html>
