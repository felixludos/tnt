<!DOCTYPE html>
<html>
  <head>
    <title>a94</title>
    <!-- <link rel="shortcut icon" href="" /> -->
    <link rel="shortcut icon" href="/a/assets/palmtree.ico" />
    <!-- <link rel="shortcut icon" href="#" /> -->
    <link rel="stylesheet" type="text/css" href="/a/css/selectStyle.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/autocomp.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/main.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/layout.css" />
    <link rel="stylesheet" type="text/css" href="/a/css/msStyles.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.12.2/js-yaml.js"></script>

    <script src="/a/js/ASender.js"></script>
    <script src="/a/js/NAssets.js"></script>
    <script src="/a/js/unitTestIOHelpers.js"></script>
    <script src="/a/js/helpers.js"></script>
    <script src="/a/js/helpersTnt.js"></script>
    <script src="/a/js/panzoom.js"></script>
    <script src="/a/js/MS.js"></script>
    <script src="/a/js/NPage.js"></script>
    <script src="/a/js/AMap.js"></script>
    <script src="/a/js/AHand.js"></script>
    <script src="/a/js/ACards.js"></script>
    <script src="/a/js/AUnits.js"></script>
    <script src="/a/js/AStrategy.js"></script>
    <script src="/a/js/ADecisiongen.js"></script>
    <script src="/a/js/unitTests.js"></script>
  </head>
  <body>
    <!-- #region HTML -->
    <div id="mainDiv" class="grid_game">
      <div id="status_area" class="grid_div">
        <div id="status_info" style="float:right;margin-right:10px;"></div>
        <div id="ui_control" style="float:left;text-align:left;margin-left:10px;">
          <div id="dFrozen" style="color:darkviolet;">wait...</div>
          <div id="dAutoplay" class="hidden" style="color:red;">
            autoplay...
            <button id="bStop" style="color:white;background-color:red" onclick="onClickStop()">STOP</button>
          </div>
          <div id="dActive" class="hidden" style="color:rgb(0, 104, 0);">Select Action:</div>
          <button id="bNextPlayer" class="hidden" style="color:green;" onclick="onClickNextPlayer()">Next Player</button>
        </div>
        <div id="status_message"></div>
      </div>
      <div id="map_area" class="grid_div" style="background-color:rgba(86, 182, 222);">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="mapG" viewBox="0 0 3400 2200">
            <image id="imgMap" width="3400" height="2200" href="/a/assets/TTmap.jpg" />
          </g>
        </svg>
      </div>
      <div id="edit_area" class="grid_div">
        <div id="uiEditButtons">
          <button onclick="onClickScenario('West','spring_start')">spring start</button>
          <button onclick="onClickViolation1()">violation</button>
          <!-- <button onclick="onClickScenario('USSR','test_movement')">movement</button>
          <button onclick="onClickScenario('West','move2')">move 2</button>
          <button onclick="onClickScenario('USSR','winter1')">winter36</button>
          <button onclick="onClickScenario('USSR','violationImminent')">violation</button>
          <button onclick="onClickScenario('USSR','conflict1')">conflict</button> -->

          <!-- <p style="margin-bottom:0px;font-size:14pt;">front ONLY:</p>
          <button id="bAddInfluence" onclick="onClickAddInfluence(this)">
            add influence
          </button>
          <button id="bRemoveInfluence" onclick="onClickRemoveInfluence(this)">
            remove influence
          </button>
          <p style="margin-bottom:0px;font-size:14pt;">front+back:</p>
          <button id="bEditTest" class="hidden" style="margin-top:24px;" onclick="onClickEditTest(this)">
            edit test
          </button>
          <button id="bAddUnit" class="hidden" onclick="onClickAddUnit(this)">add unit</button> -->
        </div>
      </div>
      <div id="select_area" class="grid_div">
        <div id="divSelect" class="sidenav"></div>
      </div>
      <div id="command_area" class="grid_div">
        <div id="uiActiveButtons" class="hidden">
          <button id="bStep" onclick="decider.onClickStep(H)">step</button>
          <button id="bRunToEnd" onclick="onClickRunToEnd()">run to end</button>
          <button onclick="onClickRunToPhase('Government')">run to gov</button>
          <button onclick="onClickRunToPhase('Spring')">run to spring</button>
          <button onclick="onClickRunToPhase('Movement')">run to move</button>
          <!-- <button id="bPlayWest" onclick="onClickPlay(this)">play West</button>
          <button id="bPlayUSSR" onclick="onClickPlay(this)">play USSR</button>
          <button id="bPlayAxis" onclick="onClickPlay(this)">play Axis</button> -->
          <button id="bRestart" style="margin-top:24px;background-color:orangered;" onclick="onClickRestart(this)">restart</button>
          <button id="bRestartParams" style="background-color:orangered;" onclick="onClickRestartParams(this)">
            restart params
          </button>
        </div>
      </div>
      <div id="log_area" class="grid_div" style="max-height:760px;overflow-y:scroll"></div>
      <div id="command2_area" class="grid_div">
        <div id="ui2Buttons">
          <button id="bSave" onclick="onClickSave()">save</button>
          <button id="bLoad" onclick="onClickLoad()">load</button>

          <button id="bSaveAs" style="margin-top:24px" onclick="onClickSaveAs()">save as</button>
          <button id="bLoadAs" onclick="onClickLoadAs()">load as</button>

          <button id="bSaveActions" style="margin-top:24px" onclick="onClickSaveActions()">save actions</button>
        </div>
      </div>
      <div id="hand_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="handG_Axis" style="visibility:hidden"><text x="10" y="25" fill="grey">Axis</text></g>
          <g id="handG_USSR" style="visibility:hidden"><text x="10" y="25" fill="red">USSR</text></g>
          <g id="handG_West" style="visibility:hidden"><text x="10" y="25" fill="blue">West</text></g>
        </svg>
      </div>
      <div id="cards2_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="openCardG"><text x="10" y="25" fill="grey">open</text></g>
          <g id="actionDeckG"><text x="10" y="25" fill="grey">action</text></g>
        </svg>
      </div>
      <div id="cards3_area" class="grid_div" style="height:200px">
        <svg width="100%" height="100%" style="box-sizing:border-box;">
          <g id="discardedG"><text x="10" y="25" fill="grey">discarded</text></g>
          <g id="investmentDeckG"><text x="10" y="25" fill="grey">investment</text></g>
        </svg>
      </div>
    </div>
    <!-- #endregion HTML -->

    <!-- #region UI / handlers, helpers TODO: cleanup -->
    <script>
      function activateWaitingForServer() {
        show(document.getElementById("dFrozen"));
        hide(document.getElementById("dAutoplay"));
        hide(document.getElementById("dActive"));
        hide(document.getElementById("uiActiveButtons"));
        hide(document.getElementById("uiEditButtons"));
        hide(document.getElementById("bNextPlayer"));
      }
      function activateNextPlayerButton() {
        hide(document.getElementById("dFrozen"));
        hide(document.getElementById("dAutoplay"));
        hide(document.getElementById("dActive"));
        hide(document.getElementById("uiActiveButtons"));
        hide(document.getElementById("uiEditButtons"));
        show(document.getElementById("bNextPlayer"));
      }
      function activateUserSelection() {
        hide(document.getElementById("dFrozen"));
        hide(document.getElementById("dAutoplay"));
        show(document.getElementById("dActive"));
        show(document.getElementById("uiActiveButtons"));
        show(document.getElementById("uiEditButtons"));
        hide(document.getElementById("bNextPlayer"));
      }
      function activateAutoplay() {
        hide(document.getElementById("dFrozen"));
        show(document.getElementById("dAutoplay"));
        hide(document.getElementById("dActive"));
        hide(document.getElementById("uiActiveButtons"));
        hide(document.getElementById("uiEditButtons"));
        hide(document.getElementById("bNextPlayer"));
      }
      function callNextAction() {
        if (H.nextAction) {
          activateWaitingForServer();
          H.nextAction();
        } else {
          error("NO NEXT ACTION!!!!!!!");
        }
      }
      function freezeUI() {
        decider.clear();
        activateWaitingForServer();
      }
      function unfreezeUI() {
        //decider.clear();
        activateUserSelection();
      }
      function printActions(data) {
        if ("actions" in data) {
          console.log(data.actions);
          // if ('set' in data.actions){
          //   console.log(data.actions.set.toString());
          // }else{
          //   console.log(data.created.toString());
          // }
        } else {
          console.log("... no actions ...");
        }
      }
      function printCreatedUnits(data) {
        console.log("...created:");
        if ("created" in data) {
          for (const id in data.created) {
            let o = data.created[id];
            if (o.obj_type != "unit") continue;
            console.log(id, o.nationality, o.tile, o.type);
          }
        }
      }
      function onClickScenario(player, fname, seed = 0) {
        freezeUI();
        restart(player, fname, seed);
      }
      function onClickViolation1() {
        freezeUI();
        initState();
        let data = {};
        let chain = ["action/West/pass", "action/Axis/pass", "action/USSR/action_13", "action/West/pass", "action/Axis/pass"];
        sendLoading("spring_start", "West", d0 => {
          updateCycle(d0);
          sendAction("West", ["pass"], d1 => {
            updateCycle(d1);
            sendAction("Axis", ["pass"], d2 => {
              updateCycle(d2);
              sendAction("USSR", ["action_13"], d3 => {
                updateCycle(d3);
                sendAction("West", ["pass"], d4 => {
                  updateCycle(d4);
                  sendAction("Axis", ["pass"], gameloop);
                });
              });
            });
          });

          // sender.chainSend(chain, "West", d1 => {
          //   data = extend(true, data, d1);
          //   gameloop(data);
          // });
        });
      }
      function onClickAddUnit() {
        freezeUI();
        let dOrig = H.serverData;
        console.log(dOrig);
        let tuple = randomUnitTuple();
        sendEditAction(H.player, tuple, dEdit => {
          console.log("back from edit", dEdit);
          if ("created" in dEdit) {
            dOrig = extend(true, dOrig, dEdit);
            console.log("nach extend und edit", dOrig);
            printCreatedUnits(dOrig);
            printActions(dOrig);
          }
          gameloop(dOrig);
        });
      }
      function onClickAddInfluence() {
        testAddInfluence(map, H.objects);
      }
      function onClickRemoveInfluence() {
        testRemoveInfluence(map, H.objects);
      }
      function onClickEditTest() {
        //enter edit mode
        // in edit mode, all units are visible
        if (execOptions.mode != "edit") {
          execOptions.mode = "edit";
        }
        //decider.cancel();
        testEdit(serverData);
        //sender.send('edit/'+H.player+'/USSR+Moscow+Infantry',dEdit=>{
        //  let newUnit = Object.values(dEdit.created)[0];
        //  let newId = Object.keys(dEdit.created)[0];
        //  dInit.created[newId]=newUnit;
        //  gameloop(dInit);
        //});
        //restart with random H.player, do NOT change role!
        //let pl = chooseRandom(assets.factionNames);
        //console.log("restarting with", pl, assets.factionNames.toString());
        //restart(pl);
      }
      function onClickNextPlayer() {
        callNextAction();
      }
      function onClickPlay(b) {
        // do not restart, just change role: execOptions.skipCond
        //b.classList.add('selected')
        //was ich will wenn einer auch playWest clicked:
        //toggle

        let pl = stringAfter(b.id, "Play");
        //toggle this player
        console.log("before toggle", execOptions.manualPlay.toString());
        console.log(execOptions.skipCond);
        if (execOptions.manualPlay.includes(pl)) {
          console.log("player", pl, "is in manualPlay!");
          removeInPlace(execOptions.manualPlay, pl);
          console.log(execOptions.manualPlay);
          b.classList.remove("toggleSelected");
        } else {
          console.log("player", pl, "is NOT in manualPlay!");
          execOptions.manualPlay.push(pl);
          b.classList.add("toggleSelected");
        }
        console.log("after toggle", execOptions.manualPlay.toString());
        console.log(execOptions.skipCond, H.player);
        STOP = false;
        decider.onClickStep(H);
      }
      function onClickRestart() {
        //restart with random player, do NOT change role!
        let pl = chooseRandom(assets.factionNames);
        console.log("restarting with", pl, assets.factionNames.toString());
        restart(pl);
      }
      function onClickRestartParams() {
        params = prompt("enter player [seed]:");
        let pl = capitalize(stringBefore(params, " "));
        let sd = firstNumber(params);
        if (sd < 0) sd = randomNumber();
        console.log("restarting with player", pl, "and seed", sd);
        restart(pl, "", sd);
      }
      function onClickRunToEnd() {
        STOP = false;
        execOptions.manualPlay = []; //skipCond = () => true;
        decider.onClickStep(H);
      }
      function onClickRunToPhase(ph) {
        STOP = false;
        execOptions.skipCond = () => H.phase != ph;
        decider.onClickStep(H);
      }
      function onClickLoad() {
        freezeUI();
        restart(H.player, "test1");
      }
      function onClickSave() {
        freezeUI();
        let dOrig = H.serverData;
        sender.send("savetest1", d => {
          sender.send("status/" + H.player, d1 => {
            unfreezeUI();
            gameloop(dOrig);
          });
        });
      }
      function onClickLoadAs() {
        fname = prompt("filename no ext.:");
        freezeUI();
        restart("West", fname);
      }
      function onClickSaveAs() {
        fname = prompt("filename no ext.:");
        freezeUI();
        let dOrig = H.serverData;
        sender.send("mysave/" + fname, d => {
          sender.send("status/" + H.player, d1 => {
            unfreezeUI();
            gameloop(dOrig);
          });
        });
      }
      function onClickSaveActions() {
        saveToDownloads(decider.selectedTuples, "_actions_" + H.filename);
      }
      function onClickStop() {
        unitTestControl("*** onClickStop!!! ***");
        STOP = true;
      }
      function statusMessage(msg = "") {
        let s = "Phase:" + H.phase + ", Year:" + H.year + ", Player:" + H.player;
        document.getElementById("status_info").innerHTML = s;
        if (!empty(msg)) document.getElementById("status_message").innerHTML = msg;
      }
    </script>
    <!-- #endregion handlers -->

    <!-- #region control flow -->
    <script>
      function gameloop(data) {
        //testing
        // STOP = unitTestRemovedCheck(data);
        unitTestControl("*** gameloop: updating ***", data);
        testOutput({0: ["gameloop:", data]});

        //update
        updateCycle(data);

        //player change if no actions OR decide next action
        if (empty(H.tuples)) {
          let waitingSet = getSet(data, "waiting_for");
          if (empty(waitingSet)) {
            unitTestControl("*** gameloop: sending empty action ***");
            sendEmptyAction(H.player, gameloop);
          } else {
            unitTestControl("*** gameloop: setting nextAction to sendChangeToPlayer ***");
            H.nextAction = () => sendChangeToPlayer(waitingSet[0], gameloop);

            //player change manual or automatic:
            if (execOptions.playerChange == "auto") callNextAction();
            else show(bNextPlayer);
          }
        } else {
          //autoplay, testing
          let autoplay = execOptions.skipCond() && !STOP;
          unitTestAutoplay("***check autoplay:", execOptions.skipCond, autoplay);
          if (autoplay) activateAutoplay();
          else {
            execOptions.skipCond = defaultSkipCond;
            activateUserSelection();
          }
          unitTestControl("*** gameloop: calling decider.genMove ***");
          unitTestControl("autoplay:", autoplay, "player", H.player);

          //actions: decider generates a move:
          decider.genMove(H, t => sendAction(H.player, t, gameloop), autoplay);
        }
        window.scrollTo(0, 0);
      }
      function updateCycle(data) {
        //TODO: get rid of global variables, consolidate to G
        H.serverData = data;
        updateStepPlayerPhaseYear(data);
        updateLog(data);
        mergeCreatedAndUpdated(data);
        cards.update(H.player, data, H.objects);
        map.update(data, H.objects);
        units.update(data, H.objects, H.player);
        H.tuples = getTuples(data);
        H.phase = H.phase;
        H.year = H.year;
        H.tuples = H.tuples;
        H.objects = H.objects;
        H.serverData = H.serverData;
      }
      function updateStepPlayerPhaseYear(data) {
        H.moveCounter += 1;
        //console.log(moveCounter, ": gameloop");
        if ("game" in data) {
          H.year = Number(data.game.year);
          H.phase = data.game.phase;

          //handle player change
          if (data.game.player != H.player) {
            H.player = data.game.player;
          }

          statusMessage();
        } else {
          console.log("data:", data);
          statusMessage("EDIT MODE!");
          //error("updateStepPlayerPhaseYear: MISSING GAME DATA!!!");
        }
      }
      function updateLog(data) {
        if ("log" in data && !empty(data.log)) {
          let d = document.getElementById("log_area");
          let para = document.createElement("p");
          para.innerHTML = data.log;
          d.appendChild(para);
          para.scrollIntoView();
        }
      }
    </script>
    <!-- #endregion control flow -->

    <!-- #region init and restart -->
    <script>
      function initState() {
        H.player = "Axis"; //default
        H.year = 1935;
        H.phase = "Setup";
        H.objects = {};

        H.nextAction = null;
        H.serverData = null;
        H.moveCounter = 0;
        H.seed = 0;
        H.filename = "_" + H.player + "_" + H.seed;
        STOP = false;

        sender = new ASender(execOptions);
        map = new AMap(assets);
        cards = new ACards(assets);
        units = new AUnits(assets);
        decider = new ADecisiongen(assets, map, cards, units, sender);
      }
      function restart(player = "Axis", fname = "", seed = 0) {
        page.clearAllObjects();
        assets.clear();
        initState();
        H.player = player;
        H.filename = fname;
        H.seed = seed;

        if (empty(H.filename)) {
          H.filename = "_" + H.player + "_" + H.seed;
          sendInit(H.player, gameloop, H.seed);
        } else sendLoading(H.filename, H.player, gameloop);
      }
    </script>
    <!-- #endregion init and restart -->

    <!-- #region globals -->
    <script>
      var H = {}; //package up all game info

      //control flow and console output flags
      var STOP; //to interrupt autoplay
      const defaultSkipCond = () => !execOptions.manualPlay.includes(H.player);
      var execOptions = {
        mode: "game", // 'game' || 'edit' not used
        outputLevel: 0, // (see testOutput: )
        playerChange: "auto", // 'auto' | 'manual'
        skipCond: defaultSkipCond, //!execOptions.manualPlay.includes(player), // predicate func evaluating to cond for autoplay
        manualPlay: ["Axis", "West", "USSR"],
        activatedTests: [] // unitTest flags to control output
      };

      var page = new NPage().initView().selectView();
      panzoom("mapG"); //handles pan zoom on map
      var assets = new NAssets();

      // controllers responsible for different aspects of game
      var sender;
      var map; //responsible for tile influence nation chip
      var cards;
      var units;
      var decider; //responsible for move generation

      $(document).ready(function() {
        initState();
        assets.initAssets(map, startScript);
      });
    </script>
    <!-- #endregion globals -->

    <!-- #region execution starts here! -->
    <script>
      function startScript() {
        //addIf("control", execOptions.activatedTests);
        //addIf("units", execOptions.activatedTests);
        //addIf("moving", execOptions.activatedTests);
        addIf("strategy", execOptions.activatedTests);

        //testMovement("", "USSR");
        // addIf("removed", execOptions.activatedTests);
        // H.player = "Axis";
        sendInit(H.player, gameloop, H.seed);

        //beiH.seed = 4: kommt nur influence von <= 2 zustande!
        //beiH.seed = 1: geht nicht, in gov phase kommt fehler: USA cannot become satellite of Axis
        //tryH.seed = 2: nur <= 2
        //tryH.seed = 3: usa becoming satellite of Axis! mit West kommt nicht ueber 1

        //H.player = "USSR";
        //testEditModeCreateUnit();

        //testControlFlow(H.player);
        // testInitToEnd(H.player,4); //ok
        // testLoadToEnd('Axis','prod_complete'); //ok
        // testCreateSingleUnit(); //ok
        // testCreateMultipleUnitsOnSameTile(); //ok
        // testIntegrationUnits(); //ok
        // testIntegrationMap(); //ok
        // testCreateOneCard(); //ok
        // testCreateNCards(); //ok
        // testIntegrationCards(); //ok
      }
    </script>
    <!-- #endregion execution -->
  </body>
</html>
